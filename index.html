<!DOCTYPE html>
<html lang="es" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Etiquetas H√≠brido</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.17.4/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style>
        /* --- ESTILOS VISUALES FUTURISTAS --- */
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; background-image: radial-gradient(circle at top left, #e0e7ff 0%, #f0f2f5 40%); transition: background-color: 0.4s ease; min-height: 10vh; }
        .dark body { background-color: #0f172a; background-image: radial-gradient(circle at top left, #1e293b 0%, #0f172a 40%); }
        .glass-card { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .dark .glass-card { background: rgba(29, 41, 60, 0.5); border: 1px solid rgba(255, 255, 255, 0.08); }
        .futuristic-btn { transition: all 0.3s ease; }
        .futuristic-btn:hover { transform: translateY(-2px); }
        #print-button { box-shadow: 0 4px 15px 0 rgba(34, 197, 94, 0.4); }
        #print-button:hover { box-shadow: 0 8px 25px 0 rgba(34, 197, 94, 0.6); }
        #clear-button { box-shadow: 0 4px 15px 0 rgba(244, 63, 94, 0.3); }
        #clear-button:hover { box-shadow: 0 8px 25px 0 rgba(244, 63, 94, 0.5); }
        
        /* --- ESTILOS PARA CELDAS EDITABLES --- */
        [contenteditable="true"] {
            outline: none;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
        }
        .dark [contenteditable="true"] {
             background-color: rgba(255, 255, 255, 0.05);
        }
        [contenteditable="true"]:focus {
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5);
            background-color: rgba(232, 237, 255, 0.5);
        }
        .dark [contenteditable="true"]:focus {
            background-color: rgba(67, 56, 202, 0.2);
        }

        /* Indicador visual de celda activa */
        [contenteditable="true"]:hover {
            background-color: rgba(99, 102, 241, 0.1);
            cursor: text;
        }

        .dark [contenteditable="true"]:hover {
            background-color: rgba(99, 102, 241, 0.15);
        }

        /* Animaci√≥n al pegar datos */
        @keyframes paste-flash {
            0%, 100% { background-color: rgba(99, 102, 241, 0.2); }
            50% { background-color: rgba(99, 102, 241, 0.4); }
        }

        .pasted-cell {
            animation: paste-flash 0.6s ease-in-out;
        }

        /* --- Estilos de Etiquetas (Funcional) --- */
        .etiqueta-zebra { width: 100mm; height: 50mm; }
        
        .etiqueta-base { 
            box-sizing: border-box; 
            background-color: white; 
            break-inside: avoid; 
            overflow: hidden; 
            border: 2px solid black;
            width: 100%;
            height: 100%;
        }


        /* --- Estilos UI (Funcional) --- */
        .message-box { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out; }
        #search-results { position: absolute; max-height: 250px; overflow-y: auto; z-index: 50; width: 100%; top: 100%; left: 0; }
        
        /* --- CLASE PARA OCULTAR EN PANTALLA Y MOSTRAR EN IMPRESI√ìN --- */
        .print-only {
            display: none;
        }

        /* --- ESTILOS DE IMPRESI√ìN CORREGIDOS --- */
        @media print {
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block !important;
            }
            html, body {
                margin: 0 !important;
                padding: 0 !important;
                height: initial !important;
                overflow: initial !important;
                -webkit-print-color-adjust: exact;
                background: none !important;
            }
            
            .etiqueta-base {
                box-shadow: none !important;
                margin: 0 !important;
                background-color: white !important;
                color: black !important;
                padding: 0 !important;
                border: 2px solid black !important;
            }
            .etiqueta-base * {
                color: black !important;
            }

            @page {
                size: A4;
                margin: 10mm;
            }
            
            body.print-a4 .page-container {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                grid-template-rows: repeat(8, 1fr) !important;
                gap: 0 !important;
                width: 190mm;
                height: 277mm;
            }
            
            body.print-zebra @page {
                size: 100mm 50mm;
                margin: 0;
            }
            body.print-zebra #print-area {
                width: auto;
                height: auto;
            }
            body.print-zebra #labels-container {
                margin: 0; padding: 0; display: block !important;
            }
            body.print-zebra .etiqueta-base {
                width: 100mm;
                height: 50mm;
            }
        }

        .template-btn { transition: all 0.3s ease; }
        .active-template { background-color: white; color: #4f46e5; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .inactive-template { background-color: transparent; color: #4338ca; }
        .dark .active-template { background-color: #4f46e5; color: white; }
        .dark .inactive-template { color: #a5b4fc; }

        /* Estilos para el indicador de maestro cargado */
        .master-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-top: 0.75rem;
        }
        .master-loaded {
            background-color: rgba(34, 197, 94, 0.1);
            color: rgb(22, 163, 74);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        .dark .master-loaded {
            background-color: rgba(34, 197, 94, 0.2);
            color: rgb(134, 239, 172);
        }
    </style>
</head>
<body class="p-4 md:p-8 text-slate-700 dark:text-slate-300">

    <main class="max-w-7xl mx-auto no-print">
        
        <header class="flex flex-col items-center justify-center mb-10 text-center">
            <div class="flex items-center gap-4 mb-2">
                <h1 class="text-4xl md:text-5xl font-extrabold text-slate-800 dark:text-white">Generador de Etiquetas</h1>
                <button id="theme-toggle" class="p-2 rounded-full text-slate-500 dark:text-slate-400 hover:bg-black/10 dark:hover:bg-white/10 transition-colors duration-200">
                    <svg id="theme-icon-light" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg id="theme-icon-dark" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
            </div>
            <p class="text-lg text-slate-600 dark:text-slate-400 max-w-2xl">Crea etiquetas de almac√©n de forma eficiente: carga archivos o introduce datos manualmente.</p>
        </header>

        <section class="glass-card p-6 md:p-8 rounded-2xl shadow-lg mb-10" style="position: relative; z-index: 10;">
            <div class="mb-8 border-b border-white/20 pb-8">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-6">1. Cargar Maestro de Productos</h2>
                <p class="text-sm text-slate-500 dark:text-slate-400 mb-3">Sube el archivo maestro (base de datos de productos) para habilitar la b√∫squeda y el autocompletado. El archivo se guardar√° autom√°ticamente en tu navegador.</p>
                
                <div class="flex flex-col md:flex-row gap-3 items-start md:items-center">
                    <input type="file" id="master-file-input" accept=".xlsx, .xls, .csv" class="block w-full md:flex-1 text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200 dark:file:bg-blue-900/50 dark:file:text-blue-300 dark:hover:file:bg-blue-800/50 cursor-pointer futuristic-btn">
                    
                    <button id="clear-master-btn" class="hidden px-4 py-2 bg-red-100 text-red-700 font-semibold rounded-full hover:bg-red-200 dark:bg-red-900/50 dark:text-red-200 dark:hover:bg-red-800/50 transition-colors text-sm futuristic-btn whitespace-nowrap">
                        Eliminar Maestro
                    </button>
                </div>

                <div id="master-status" class="hidden master-indicator master-loaded">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span id="master-status-text">Maestro cargado</span>
                </div>
            </div>

            <div class="mb-8 border-b border-white/20 pb-8">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-6 flex justify-between items-center cursor-pointer" onclick="toggleCollapsible('data-load-content', 'toggle-icon-data-load')">
                    <span>2. Cargar Datos para Impresi√≥n</span>
                    <span id="toggle-icon-data-load" class="transform transition-transform duration-300">‚ñº</span>
                </h2>
                <div id="data-load-content" class="collapsible-content">
                    <div class="grid md:grid-cols-2 gap-8 mt-4">
                        <div class="relative">
                             <h3 class="font-semibold text-slate-700 dark:text-slate-200 mb-2">2.A B√∫squeda en Maestro</h3>
                             <p class="text-sm text-slate-500 dark:text-slate-400 mb-3">Busca por c√≥digo o descripci√≥n. Navega con (‚Üë‚Üì) y presiona Enter para a√±adir al resumen.</p>
                             <input type="text" id="search-input" placeholder="Cargue el archivo maestro para buscar..." disabled class="w-full p-3 bg-white/30 dark:bg-slate-900/50 border border-white/20 dark:border-slate-700 rounded-lg placeholder:text-slate-500 focus:ring-2 focus:ring-indigo-400 focus:border-transparent disabled:bg-slate-200/50 dark:disabled:bg-slate-800/50">
                             <div id="search-results" class="hidden bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 mt-2 rounded-lg shadow-xl"></div>
                        </div>
                        <div>
                            <h3 class="font-semibold text-slate-700 dark:text-slate-200 mb-2">2.B Cargar desde Excel/CSV</h3>
                            <p class="text-sm text-slate-500 dark:text-slate-400 mb-3">Sube un archivo con c√≥digos y cantidades para agregarlos directamente al resumen de impresi√≥n.</p>
                            <input type="file" id="excel-file-input" accept=".xlsx, .xls, .csv" class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:font-semibold file:bg-green-100 file:text-green-700 hover:file:bg-green-200 dark:file:bg-green-900/50 dark:file:text-green-300 dark:hover:file:bg-green-800/50 cursor-pointer futuristic-btn">
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="summary-section" class="glass-card p-6 md:p-8 rounded-2xl shadow-lg mb-10" style="position: relative; z-index: 5;">
            <div class="flex justify-between items-center mb-4 border-b border-white/20 pb-4 cursor-pointer" onclick="toggleCollapsible('summary-content', 'toggle-icon-summary')">
               <h2 class="text-2xl font-bold text-slate-800 dark:text-white">3. Resumen de Datos para Impresi√≥n</h2>
               <div class="flex items-center space-x-4">
                    <button onclick="addSummaryRow(event)" class="px-5 py-2 bg-slate-100 text-slate-800 font-semibold rounded-full hover:bg-slate-200 dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600 transition-colors text-sm futuristic-btn">A√±adir Fila</button>
                    <button onclick="clearSummary(event)" class="px-5 py-2 bg-rose-100 text-rose-800 font-semibold rounded-full hover:bg-rose-200 dark:bg-rose-900/50 dark:text-rose-200 dark:hover:bg-rose-800/50 transition-colors text-sm futuristic-btn">Limpiar Resumen</button>
                    <button onclick="downloadExcel(event)" class="px-5 py-2 bg-green-100 text-green-800 font-semibold rounded-full hover:bg-green-200 dark:bg-green-900/50 dark:text-green-200 dark:hover:bg-green-800/50 transition-colors text-sm futuristic-btn">üì• Descargar Excel</button>
                    <span id="toggle-icon-summary" class="transform transition-transform duration-300">‚ñº</span>
               </div>
            </div>
            <div id="summary-content" class="collapsible-content">
                <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">Edita cualquier celda o pega datos desde una hoja de c√°lculo. Los cambios se reflejar√°n al instante. Puedes pegar datos desde cualquier columna.</p>
                <div class="overflow-x-auto overflow-y-auto rounded-lg border border-white/20 dark:border-slate-700" style="max-height: 25rem;">
                    <table id="data-table" class="min-w-full">
                        <thead class="bg-slate-200 dark:bg-slate-700 sticky top-0 z-10">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-600 dark:text-slate-200 uppercase tracking-wider">C√≥digo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-600 dark:text-slate-200 uppercase tracking-wider">Descripci√≥n</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-600 dark:text-slate-200 uppercase tracking-wider">UNDM</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-600 dark:text-slate-200 uppercase tracking-wider">OC</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-600 dark:text-slate-200 uppercase tracking-wider">Usuario</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-600 dark:text-slate-200 uppercase tracking-wider">Cantidad</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-600 dark:text-slate-200 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body" class="divide-y divide-white/20 dark:divide-slate-700">
                        </tbody>
                    </table>
                </div>
                </div>
        </section>

        <section class="glass-card p-6 md:p-8 rounded-2xl shadow-lg mb-10">
            <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-6 border-b border-white/20 pb-4">4. Controles de Salida</h2>
            
            <div>
                <label class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-3">Seleccionar Plantilla de Impresi√≥n:</label>
                <div id="template-selector" class="grid grid-cols-1 sm:grid-cols-2 gap-2 bg-slate-200/80 dark:bg-slate-900/50 rounded-full p-1 futuristic-btn">
                    <button data-template="a4" class="template-btn active-template w-full px-4 py-2 rounded-full text-sm font-semibold">Hoja A4 (24 por Hoja)</button>
                    <button data-template="zebra" class="template-btn inactive-template w-full px-4 py-2 rounded-full text-sm font-semibold">Zebra (Individual)</button>
                </div>
            </div>
            
            <div class="my-6 text-center">
                <p id="page-counter" class="text-md font-semibold text-slate-700 dark:text-slate-300 transition-opacity duration-300 opacity-0"></p>
            </div>

            <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                <button onclick="printLabels()" id="print-button" class="futuristic-btn w-full md:w-auto px-8 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold rounded-full disabled:opacity-50 disabled:cursor-not-allowed">Imprimir Etiquetas</button>
                <button onclick="clearAllData()" id="clear-button" class="futuristic-btn w-full md:w-auto px-8 py-3 bg-gradient-to-r from-rose-500 to-red-600 text-white font-bold rounded-full">Borrar Todo</button>
            </div>
        </section>
        
        <div class="no-print">
            <h2 class="text-2xl font-bold text-slate-800 dark:text-white mt-12 mb-4">5. Vista Previa de Etiquetas</h2>
            <div id="preview-area" class="p-4 bg-slate-200/50 dark:bg-slate-900/50 rounded-lg min-h-[200px] flex items-center justify-center">
                 <div id="preview-labels-container" class="flex flex-wrap justify-center gap-2">
                         <p class="text-slate-500 dark:text-slate-400">A√±ade productos para generar la vista previa.</p>
                 </div>
            </div>
        </div>

    </main>
    
    <div id="print-area" class="print-only">
        <div id="labels-container"></div>
    </div>
    
    <footer class="text-center mt-12 mb-4 no-print">
        <p class="text-sm font-medium text-slate-500 dark:text-slate-400">CREADO POR EYNER GARCIA</p>
    </footer>

    <div id="message-container" class="message-box"></div>

    <script>
        // --- Variables Globales ---
        let masterProductData = [];
        let summaryData = [];
        let currentTemplate = 'a4';

        // --- Constantes para LocalStorage ---
        const MASTER_STORAGE_KEY = 'etiquetas_master_productos';
        const MASTER_TIMESTAMP_KEY = 'etiquetas_master_timestamp';

        // --- Elementos del DOM ---
        const masterFileInput = document.getElementById('master-file-input');
        const excelFileInput = document.getElementById('excel-file-input');
        const searchInput = document.getElementById('search-input');
        const searchResultsContainer = document.getElementById('search-results');
        const dataTableBody = document.getElementById('data-table-body');
        const labelsContainer = document.getElementById('labels-container');
        const previewLabelsContainer = document.getElementById('preview-labels-container');
        const printButton = document.getElementById('print-button');
        const masterStatus = document.getElementById('master-status');
        const masterStatusText = document.getElementById('master-status-text');
        const clearMasterBtn = document.getElementById('clear-master-btn');
        
        // --- L√≥gica del Tema ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const lightIcon = document.getElementById('theme-icon-light');
        const darkIcon = document.getElementById('theme-icon-dark');
        const applyTheme = (theme) => { if (theme === 'dark') { document.documentElement.classList.add('dark'); lightIcon.classList.add('hidden'); darkIcon.classList.remove('hidden'); } else { document.documentElement.classList.remove('dark'); lightIcon.classList.remove('hidden'); darkIcon.classList.add('hidden'); } };
        themeToggleBtn.addEventListener('click', () => { const newTheme = localStorage.getItem('theme') === 'light' ? 'dark' : 'light'; localStorage.setItem('theme', newTheme); applyTheme(newTheme); });
        applyTheme(localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));

        // --- Funciones de Utilidad ---
        const showMessage = (message, type = 'success') => { const c = document.getElementById('message-container'), e = document.createElement('div'), l = type === 'success', o = l ? 'bg-green-100 text-green-800 dark:bg-green-900/70 dark:text-green-200 border-green-300/50' : 'bg-red-100 text-red-800 dark:bg-red-900/70 dark:text-red-200 border-red-300/50'; e.className = `p-4 rounded-xl shadow-lg mb-2 border ${o} opacity-0 transition-all duration-500 backdrop-blur-sm`; e.innerHTML = `<strong class="font-semibold">${l ? '√âxito' : 'Error'}:</strong> ${message}`; c.appendChild(e); void e.offsetWidth; e.style.opacity = '1'; setTimeout(() => { e.style.opacity = '0'; setTimeout(() => e.remove(), 500); }, 5000); };
        const debounce = (func, delay) => { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => func.apply(this, args), delay); }; };
        const toggleCollapsible = (contentId, iconId) => {
            const contentEl = document.getElementById(contentId);
            const iconEl = document.getElementById(iconId);
            if (!contentEl || !iconEl) return;

            if (contentEl.style.maxHeight && contentEl.style.maxHeight !== "0px") {
                contentEl.style.overflow = 'hidden';
                contentEl.style.maxHeight = "0px";
                iconEl.style.transform = "rotate(0deg)";
            } else {
                contentEl.style.maxHeight = contentEl.scrollHeight + "px";
                iconEl.style.transform = "rotate(180deg)";
                setTimeout(() => {
                    if (contentEl.style.maxHeight !== "0px") {
                        contentEl.style.overflow = 'visible';
                    }
                }, 400); 
            }
        };
        
        const openCollapsible = (contentId, iconId) => {
            const contentEl = document.getElementById(contentId);
            const iconEl = document.getElementById(iconId);
            if (!contentEl || !iconEl) return;
            // Solo abre si est√° cerrado
            if (!contentEl.style.maxHeight || contentEl.style.maxHeight === "0px") {
                contentEl.style.maxHeight = contentEl.scrollHeight + "px";
                iconEl.style.transform = "rotate(180deg)";
                setTimeout(() => {
                    contentEl.style.overflow = 'visible';
                }, 400);
            } else {
                 // Si ya est√° abierto, solo recalcula la altura para ajustarse a nuevas filas
                contentEl.style.maxHeight = contentEl.scrollHeight + "px";
            }
        };
        
        const normalizeHeader = (str) => str ? str.toString().toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : '';
        
        // --- FUNCIONES PARA GUARDAR/CARGAR MAESTRO ---
        const saveMasterToStorage = (data) => {
            try {
                const jsonData = JSON.stringify(data);
                const timestamp = new Date().toISOString();
                localStorage.setItem(MASTER_STORAGE_KEY, jsonData);
                localStorage.setItem(MASTER_TIMESTAMP_KEY, timestamp);
                updateMasterStatus(data.length, timestamp);
                return true;
            } catch (error) {
                console.error('Error al guardar maestro:', error);
                if (error.name === 'QuotaExceededError') {
                    showMessage('El archivo maestro es demasiado grande para guardar en el navegador.', 'error');
                } else {
                    showMessage('Error al guardar el maestro en el navegador.', 'error');
                }
                return false;
            }
        };

        const loadMasterFromStorage = () => {
            try {
                const jsonData = localStorage.getItem(MASTER_STORAGE_KEY);
                const timestamp = localStorage.getItem(MASTER_TIMESTAMP_KEY);
                
                if (jsonData) {
                    const data = JSON.parse(jsonData);
                    masterProductData = data;
                    searchInput.disabled = false;
                    searchInput.placeholder = 'Buscar por c√≥digo o descripci√≥n...';
                    updateMasterStatus(data.length, timestamp);
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error al cargar maestro:', error);
                showMessage('Error al cargar el maestro guardado.', 'error');
                return false;
            }
        };

        const updateMasterStatus = (count, timestamp) => {
            if (count > 0) {
                const date = timestamp ? new Date(timestamp) : new Date();
                const dateStr = date.toLocaleDateString('es-ES', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                masterStatusText.textContent = `${count} productos cargados (${dateStr})`;
                masterStatus.classList.remove('hidden');
                clearMasterBtn.classList.remove('hidden');
            } else {
                masterStatus.classList.add('hidden');
                clearMasterBtn.classList.add('hidden');
            }
        };

        const clearMasterFromStorage = () => {
            if (confirm('¬øEst√° seguro de eliminar el maestro de productos guardado?')) {
                localStorage.removeItem(MASTER_STORAGE_KEY);
                localStorage.removeItem(MASTER_TIMESTAMP_KEY);
                masterProductData = [];
                searchInput.disabled = true;
                searchInput.placeholder = 'Cargue el archivo maestro para buscar...';
                searchInput.value = '';
                updateMasterStatus(0, null);
                showMessage('Maestro de productos eliminado correctamente.', 'success');
            }
        };

        // Event listener para el bot√≥n de eliminar maestro
        clearMasterBtn.addEventListener('click', clearMasterFromStorage);
        
        // --- L√ìGICA DE CARGA DE ARCHIVO MAESTRO ---
        masterFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0]; 
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    const processedData = jsonData.map(row => {
                        const item = {};
                        for (const key in row) item[normalizeHeader(key)] = String(row[key]);
                        return item;
                    });
                    
                    masterProductData = processedData;
                    
                    // Guardar en localStorage
                    const saved = saveMasterToStorage(processedData);
                    
                    searchInput.disabled = false;
                    searchInput.placeholder = 'Buscar por c√≥digo o descripci√≥n...';
                    
                    if (saved) {
                        showMessage(`Se cargaron y guardaron ${masterProductData.length} productos del maestro.`, 'success');
                    } else {
                        showMessage(`Se cargaron ${masterProductData.length} productos (no se pudo guardar en el navegador).`, 'success');
                    }
                } catch (error) { 
                    showMessage('Error al procesar el archivo maestro.', 'error'); 
                    console.error(error); 
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // --- L√ìGICA DE B√öSQUEDA AVANZADA (PUNTO 2.A) ---
        const addProductToSummary = (item) => {
            if (summaryData.length === 1 && !summaryData[0].codigo) {
                summaryData = []; 
            }
            summaryData.push({ ...item, cantidad: 1, oc: '', usuario: '' });
            displaySummaryData();
            showMessage(`'${item.codigo}' a√±adido al resumen.`, 'success');
            
            // Arreglo de Flujo de Trabajo: Abrir la secci√≥n 3 autom√°ticamente
            openCollapsible('summary-content', 'toggle-icon-summary');
        };

        const updateSearchResults = debounce(() => {
            const query = searchInput.value.toLowerCase().trim();
            if (query.length < 2) { searchResultsContainer.classList.add('hidden'); return; }
            const results = masterProductData.filter(item => (item.descripcion?.toLowerCase().includes(query)) || (item.codigo?.toLowerCase().includes(query))).slice(0, 7);
            searchResultsContainer.innerHTML = '';
            if (results.length > 0) {
                results.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'search-result-item p-3 cursor-pointer border-b dark:border-slate-700 last:border-b-0 hover:bg-indigo-100 dark:hover:bg-slate-700';
                    if (index === 0) div.classList.add('selected-result', 'bg-indigo-100', 'dark:bg-slate-700');
                    div.dataset.code = item.codigo;
                    div.innerHTML = `<div class="font-bold text-slate-800 dark:text-white">${item.codigo}</div><div class="text-sm text-slate-600 dark:text-slate-400">${item.descripcion}</div>`;
                    div.onclick = () => { addProductToSummary(item); searchInput.value = ''; searchResultsContainer.classList.add('hidden'); };
                    searchResultsContainer.appendChild(div);
                });
                searchResultsContainer.classList.remove('hidden');
            } else {
                searchResultsContainer.classList.add('hidden');
            }
        }, 300);
        searchInput.addEventListener('input', updateSearchResults);
        searchInput.addEventListener('keydown', (event) => {
            const isVisible = !searchResultsContainer.classList.contains('hidden');
            if (!isVisible) { if (event.key === 'Enter') { event.preventDefault(); const codigoQuery = searchInput.value.trim(); if (codigoQuery) { const foundItem = masterProductData.find(item => item.codigo === codigoQuery); if (foundItem) { addProductToSummary(foundItem); searchInput.value = ''; } else { showMessage(`C√≥digo '${codigoQuery}' no encontrado.`, 'error'); } } } return; }
            const items = searchResultsContainer.querySelectorAll('.search-result-item');
            if (items.length === 0) return;
            let currentIndex = Array.from(items).findIndex(item => item.classList.contains('selected-result'));
            if (event.key === 'ArrowDown' || event.key === 'ArrowUp') {
                event.preventDefault();
                items[currentIndex]?.classList.remove('selected-result', 'bg-indigo-100', 'dark:bg-slate-700');
                if (event.key === 'ArrowDown') { currentIndex = (currentIndex + 1) % items.length; } else { currentIndex = (currentIndex - 1 + items.length) % items.length; }
                items[currentIndex].classList.add('selected-result', 'bg-indigo-100', 'dark:bg-slate-700');
                items[currentIndex].scrollIntoView({ block: 'nearest' });
            } else if (event.key === 'Enter') { event.preventDefault(); if (currentIndex > -1) { items[currentIndex].click(); } }
        });
        document.addEventListener('click', (e) => { if (searchResultsContainer && !searchResultsContainer.contains(e.target) && e.target !== searchInput) searchResultsContainer.classList.add('hidden'); });
        
        // --- L√ìGICA DE CARGA DE EXCEL/CSV (2.B) ---
        excelFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                    if (rows.length < 2) {
                        showMessage('El archivo est√° vac√≠o o no contiene filas de datos.', 'error');
                        return;
                    }
                    const dataRows = rows.slice(1);

                    const loadedItems = dataRows.map(row => {
                        const codigo = String(row[14] || '').trim();
                        if (!codigo) { return null; }
                        const cantidadStr = String(row[19] || '').trim();
                        const cantidad = parseInt(cantidadStr, 10);
                        return {
                            codigo: codigo,
                            descripcion: String(row[15] || '').trim(),
                            undm: String(row[17] || '').trim(),
                            oc: String(row[10] || '').trim(),
                            usuario: String(row[8] || '').trim(),
                            cantidad: !isNaN(cantidad) && cantidad > 0 ? cantidad : ''
                        };
                    }).filter(Boolean);

                    if (loadedItems.length > 0) {
                        if (summaryData.length === 1 && !summaryData[0].codigo) {
                            summaryData = loadedItems;
                        } else {
                            summaryData.push(...loadedItems);
                        }
                        displaySummaryData();  
                        showMessage(`Se cargaron ${loadedItems.length} productos al resumen.`, 'success');
                         // Abrir el resumen despu√©s de cargar el excel
                        openCollapsible('summary-content', 'toggle-icon-summary');
                    } else {  
                        showMessage('No se encontraron productos con c√≥digo v√°lido en la columna O del archivo.', 'error');  
                    }
                } catch (error) {  
                    showMessage('Error cr√≠tico al procesar el archivo Excel/CSV.', 'error');  
                    console.error(error);  
                } finally {  
                    excelFileInput.value = '';  
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // --- MANEJO DE LA TABLA DE RESUMEN ---
        const displaySummaryData = () => {
            dataTableBody.innerHTML = '';
            
            const content = document.getElementById('summary-content');
            const dataToDisplay = summaryData.length > 0 ? summaryData : [{ codigo: '', descripcion: '', undm: '', oc: '', usuario: '', cantidad: '' }];
            
            dataToDisplay.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = "hover:bg-slate-500/10";
                row.innerHTML = `
                    <td contenteditable="true" oninput="editSummaryField(${index}, 'codigo', this.innerText)" class="px-2 py-1">${item.codigo || ''}</td>
                    <td contenteditable="true" oninput="editSummaryField(${index}, 'descripcion', this.innerText)" class="px-2 py-1">${item.descripcion || ''}</td>
                    <td contenteditable="true" oninput="editSummaryField(${index}, 'undm', this.innerText)" class="px-2 py-1">${item.undm || ''}</td>
                    <td contenteditable="true" oninput="editSummaryField(${index}, 'oc', this.innerText)" class="px-2 py-1">${item.oc || ''}</td>
                    <td contenteditable="true" oninput="editSummaryField(${index}, 'usuario', this.innerText)" class="px-2 py-1">${item.usuario || ''}</td>
                    <td class="px-2 py-1"><input type="number" value="${item.cantidad}" oninput="editQuantity(${index}, this.value)" class="w-20 p-1.5 border rounded text-center bg-white/50 dark:bg-slate-700/50 border-white/20 dark:border-slate-600 focus:ring-2 focus:ring-indigo-400 focus:border-transparent"/></td>
                    <td class="px-2 py-1 text-center"><button onclick="deleteRow(${index})" class="text-rose-600 hover:text-rose-800 dark:text-rose-400 dark:hover:text-rose-300 p-1.5 rounded-full hover:bg-rose-500/20 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></td>
                `;
                dataTableBody.appendChild(row);
            });
            
            // Recalcular altura si el panel est√° abierto
            if (content.style.maxHeight && content.style.maxHeight !== "0px") {
                 setTimeout(() => {
                    content.style.maxHeight = content.scrollHeight + "px";
                 }, 0);
            }
            
            const tableContainer = document.querySelector('#summary-content .overflow-y-auto');
            if (tableContainer) {
                setTimeout(() => {
                    tableContainer.scrollTop = tableContainer.scrollHeight;
                }, 0);
            }

            const dataToGenerate = summaryData.filter(item => item.codigo);
            generateLabels(dataToGenerate);
        };
        
        const debouncedGenerateLabelsFromSummary = debounce(() => { 
             const dataToGenerate = summaryData.filter(item => item.codigo);
             generateLabels(dataToGenerate);
        }, 500);

        window.editSummaryField = (index, field, value) => { 
            if (index < 0 || index >= summaryData.length && !(summaryData.length === 0 && index === 0)) return; 
            if (summaryData.length === 0 && index === 0) {
                 summaryData.push({ codigo: '', descripcion: '', undm: '', oc: '', usuario: '', cantidad: '' });
            }
            if (!summaryData[index]) {
                 summaryData[index] = { codigo: '', descripcion: '', undm: '', oc: '', usuario: '', cantidad: '' };
            }
            summaryData[index][field] = value; 
            debouncedGenerateLabelsFromSummary();
        };
        window.editQuantity = (index, value) => { 
            if (index < 0 || index >= summaryData.length) return;
            if (value === '') {
                summaryData[index].cantidad = '';
            } else {
                const n = parseInt(value);
                if (!isNaN(n)) {
                    summaryData[index].cantidad = n;
                }
            }
            debouncedGenerateLabelsFromSummary();
        };
        window.deleteRow = (index) => { 
            if (index < 0 || index >= summaryData.length) return;
            summaryData.splice(index, 1);
            if (summaryData.length === 0) {
                addSummaryRow();
            } else {
                displaySummaryData(); 
            }
        };
        const addSummaryRow = (event) => {
            if(event) event.stopPropagation();
            if (summaryData.length === 1 && !summaryData[0].codigo) {
                summaryData = [];
            }
            summaryData.push({ codigo: '', descripcion: '', undm: '', oc: '', usuario: '', cantidad: '' });
            displaySummaryData();
        };

        // --- MANEJO DE PEGADO MEJORADO ---
        dataTableBody.addEventListener('paste', (event) => {
            event.preventDefault();
            event.stopPropagation();
            
            if (summaryData.length === 1 && !summaryData[0].codigo) {
                summaryData = [];
            }
            
            const pasteText = (event.clipboardData || window.clipboardData).getData('text/plain');
            const pastedRows = pasteText.trim().split(/\r\n|\n|\r/);

            const startCell = event.target.closest('td');
            if (!startCell) return;
            
            const startRow = startCell.closest('tr');
            const allRows = Array.from(dataTableBody.children);
            const startRowIndex = allRows.indexOf(startRow);
            
            const allCellsInRow = Array.from(startRow.querySelectorAll('td'));
            const startCellIndex = allCellsInRow.indexOf(startCell);

            const fieldMapping = ['codigo', 'descripcion', 'undm', 'oc', 'usuario', 'cantidad'];

            pastedRows.forEach((rowText, rowIndexOffset) => {
                const targetRowIndex = startRowIndex + rowIndexOffset;
                
                while (targetRowIndex >= summaryData.length) {
                    summaryData.push({ codigo: '', descripcion: '', undm: '', oc: '', usuario: '', cantidad: '' });
                }
                
                const pastedCells = rowText.split('\t');
                
                pastedCells.forEach((cellText, cellIndexOffset) => {
                    const targetCellIndex = startCellIndex + cellIndexOffset;
                    
                    if (targetCellIndex >= 0 && targetCellIndex < fieldMapping.length) {
                        const fieldName = fieldMapping[targetCellIndex];
                        let cleanedText = cellText.trim();
                        
                        if (fieldName === 'cantidad') {
                            const num = parseInt(cleanedText, 10);
                            summaryData[targetRowIndex][fieldName] = !isNaN(num) && num > 0 ? num : '';
                        } else {
                            summaryData[targetRowIndex][fieldName] = cleanedText;
                        }
                    }
                });
            });
            
            displaySummaryData();
            showMessage(`Datos pegados correctamente en el resumen (${pastedRows.length} fila(s)).`, 'success');
        });

        // --- PERMITIR PASTE EN CELDAS INDIVIDUALES CONTENTEDITABLE ---
        document.addEventListener('DOMContentLoaded', () => {
            document.body.addEventListener('paste', (event) => {
                const target = event.target;
                
                if (target.hasAttribute('contenteditable') && target.closest('#data-table-body')) {
                    const pasteText = (event.clipboardData || window.clipboardData).getData('text/plain');
                    
                    if (!pasteText.includes('\t') && !pasteText.includes('\n')) {
                        return;
                    }
                    
                    event.preventDefault();
                    const pasteEvent = new Event('paste', { bubbles: true, cancelable: true });
                    Object.defineProperty(pasteEvent, 'clipboardData', {
                        value: event.clipboardData
                    });
                    dataTableBody.dispatchEvent(pasteEvent);
                }
            });

            // Cargar el maestro desde localStorage al iniciar
            const loaded = loadMasterFromStorage();
            if (loaded) {
                console.log('Maestro cargado desde localStorage');
            }
        });
        
        // --- GENERACI√ìN DE ETIQUETAS ---
        const generateLabels = (data) => {
            const labelsPerPage = 24;
            const totalLabels = data.reduce((sum, item) => sum + (parseInt(item.cantidad, 10) || 0), 0);
            const pageCounterEl = document.getElementById('page-counter');
            
            if (pageCounterEl) {
                pageCounterEl.style.opacity = totalLabels > 0 ? '1' : '0';
                if (totalLabels > 0) {
                    if (currentTemplate === 'a4') {
                        const totalPages = Math.ceil(totalLabels / labelsPerPage);
                        pageCounterEl.textContent = `Se generar√°n ${totalLabels} etiquetas en ${totalPages} p√°gina(s).`;
                    } else {
                        pageCounterEl.textContent = `Se generar√°n ${totalLabels} etiquetas individuales.`;
                    }
                } else {
                    pageCounterEl.textContent = '';
                }
            }

            const createLabelElement = (item) => {
                const labelDiv = document.createElement('div');
                const isA4 = currentTemplate === 'a4';
                labelDiv.className = `etiqueta-base ${isA4 ? '' : 'etiqueta-zebra'}`;
                
                const usuarioLength = (item.usuario || '').length;
                let finalUsuarioFontSize = isA4 ? '7pt' : '9pt';

                if (usuarioLength > 22) {
                    finalUsuarioFontSize = isA4 ? '5.5pt' : '7pt';
                } else if (usuarioLength > 15) {
                    finalUsuarioFontSize = isA4 ? '6pt' : '8pt';
                }

                let qrPadding = isA4 ? '1mm' : '2mm';
                let descripcionFontSize = isA4 ? '7.5pt' : '10pt';
                let undmFontSize = isA4 ? '7.5pt' : '9.5pt';
                let ocFontSize = isA4 ? '7.5pt' : '9.5pt';
                let codigoFontSize = isA4 ? '24pt' : '30pt';

                labelDiv.innerHTML = `
                    <div style="display: flex; width: 100%; height: 100%; font-family: Arial, sans-serif;">
                        <div style="width: 33%; height: 100%; display: flex; justify-content: center; align-items: center; padding: ${qrPadding}; box-sizing: border-box;">
                            <canvas class="qr-canvas" data-code="${item.codigo}" style="width: 100%; height: 100%; object-fit: contain;"></canvas>
                        </div>
                        <div style="width: 67%; height: 100%; display: flex; flex-direction: column; border-left: 1px solid black; text-align: center;">
                            <div style="flex-grow: 1.0; border-bottom: 1px solid black; padding: 1px 2px; line-height: 1.1; font-size: ${finalUsuarioFontSize}; font-weight: bold; display: flex; align-items: center; justify-content: center; box-sizing: border-box; overflow: hidden;">${item.usuario || ''}</div>
                            <div style="flex-grow: 2.5; border-bottom: 1px solid black; padding: 1px 2px; line-height: 1.1; font-size: ${descripcionFontSize}; display: flex; align-items: center; justify-content: center; box-sizing: border-box; overflow: hidden;">
                                <div style="display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 5; overflow: hidden; text-overflow: ellipsis; max-height: 100%; text-align: center;">${item.descripcion || ''}</div>
                            </div>
                            <div style="flex-grow: 0.8; border-bottom: 1px solid black; display: flex; font-weight: bold; line-height: 1; box-sizing: border-box;">
                                <div style="width: 50%; padding: 0 2px; display: flex; align-items: center; justify-content: center; box-sizing: border-box; overflow: hidden; font-size: ${undmFontSize};">${item.undm || ''}</div>
                                <div style="width: 50%; border-left: 1px solid black; padding: 0 2px; display: flex; align-items: center; justify-content: center; box-sizing: border-box; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; font-size: ${ocFontSize};">OC: ${item.oc || ''}</div>
                            </div>
                            <div style="flex-grow: 2.2; padding: 0 2px; line-height: 1; font-size: ${codigoFontSize}; font-weight: 900; display: flex; align-items: center; justify-content: center; letter-spacing: 1px; box-sizing: border-box; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">${item.codigo || ''}</div>
                        </div>
                    </div>`;
                return labelDiv;
            };
            
            previewLabelsContainer.innerHTML = '';
            if (totalLabels === 0) {
                previewLabelsContainer.innerHTML = `<p class="text-slate-500 dark:text-slate-400">A√±ade productos para generar la vista previa.</p>`;
            } else {
                previewLabelsContainer.style.display = 'grid';
                previewLabelsContainer.style.gap = '2px';
                if(currentTemplate === 'a4') {
                    previewLabelsContainer.style.gridTemplateColumns = 'repeat(3, 1fr)';
                    previewLabelsContainer.style.gridTemplateRows = 'repeat(8, 1fr)';
                    previewLabelsContainer.style.aspectRatio = '210 / 297';
                    previewLabelsContainer.style.width = '100%';
                } else {
                    previewLabelsContainer.style.display = 'flex';
                    previewLabelsContainer.style.flexWrap = 'wrap';
                    previewLabelsContainer.style.gap = '10px';
                    previewLabelsContainer.style.aspectRatio = 'auto';
                }
                const previewFragment = document.createDocumentFragment();
                let previewCount = 0;
                for(const item of data) {
                    if (previewCount >= 24) break;
                    const quantity = parseInt(item.cantidad, 10) || 0;
                    for (let i = 0; i < quantity; i++) {
                        previewFragment.appendChild(createLabelElement(item));
                        previewCount++;
                        if (previewCount >= 24) break;
                    }
                }
                previewLabelsContainer.appendChild(previewFragment);
            }

            labelsContainer.innerHTML = '';
            if (totalLabels > 0) {
                const printFragment = document.createDocumentFragment();
                let allLabels = [];
                data.forEach(item => {
                    const quantity = parseInt(item.cantidad, 10) || 0;
                    for (let i = 0; i < quantity; i++) { allLabels.push(item); }
                });

                if (currentTemplate === 'a4') {
                    for (let i = 0; i < allLabels.length; i += labelsPerPage) {
                        const chunk = allLabels.slice(i, i + labelsPerPage);
                        const pageContainer = document.createElement('div');
                        pageContainer.className = 'page-container';
                        if (i + labelsPerPage < allLabels.length) {
                             pageContainer.style.breakAfter = 'page';
                             pageContainer.style.pageBreakAfter = 'always';
                        }
                        chunk.forEach(labelItem => pageContainer.appendChild(createLabelElement(labelItem)));
                        printFragment.appendChild(pageContainer);
                    }
                } else {
                    allLabels.forEach(labelItem => printFragment.appendChild(createLabelElement(labelItem)));
                }
                labelsContainer.appendChild(printFragment);
            }

            document.querySelectorAll('.qr-canvas').forEach(canvas => {
                if (canvas.dataset.code) {
                    try { new QRious({ element: canvas, value: canvas.dataset.code, size: 500, padding: 0, level: 'H' }); } catch (e) { console.error('QRious error:', e); }
                }
            });

            printButton.disabled = (totalLabels === 0);
        };

        const printLabels = () => { 
            const dataToPrint = summaryData.filter(item => item.codigo && parseInt(item.cantidad, 10) > 0);
            if (dataToPrint.length === 0) {
                showMessage('No hay datos v√°lidos para imprimir.', 'error');
                return;
            }
            document.body.classList.add(`print-${currentTemplate}`);
            window.print(); 
            setTimeout(() => {
                document.body.classList.remove(`print-${currentTemplate}`);
            }, 500);
        };

        const clearSummary = (event) => {
            if(event) event.stopPropagation();
            summaryData = [];
            excelFileInput.value = '';
            displaySummaryData();
            showMessage('Resumen limpiado.', 'success');
        };
        
        const clearAllData = () => {
            excelFileInput.value = ''; 
            masterFileInput.value = ''; 
            searchInput.value = ''; 
            searchInput.disabled = true; 
            searchInput.placeholder = 'Cargue el archivo maestro para buscar...';
            masterProductData = [];
            
            // NO eliminar el maestro de localStorage, solo limpiar el resto
            clearSummary();
            showMessage('Datos de trabajo borrados (el maestro se mantiene guardado).', 'success');
        };
        
        // --- INICIALIZACI√ìN ---
        document.addEventListener('DOMContentLoaded', () => { 
            displaySummaryData();
            printButton.disabled = true; 
            
            document.getElementById('template-selector').addEventListener('click', (e) => {
                const button = e.target.closest('.template-btn');
                if (button && button.dataset.template !== currentTemplate) {
                    document.querySelectorAll('.template-btn').forEach(btn => {
                        btn.classList.remove('active-template');
                        btn.classList.add('inactive-template');
                    });
                    button.classList.add('active-template');
                    button.classList.remove('inactive-template');
                    currentTemplate = button.dataset.template;
                    generateLabels(summaryData.filter(item => item.codigo));
                }
            });
        });
    

        // Funci√≥n para descargar datos compatible con 2.B Cargar desde Excel/CSV
        function downloadExcel(event) {
            if (event) event.stopPropagation();

            if (!summaryData || summaryData.length === 0) {
                alert('No hay datos para descargar. Agrega productos al resumen primero.');
                return;
            }

            // Crear encabezado con 20 columnas (posiciones correctas para 2.B)
            const headers = new Array(20).fill('');
            headers[8] = 'Usuario';
            headers[10] = 'OC';
            headers[14] = 'C√≥digo';
            headers[15] = 'Descripci√≥n';
            headers[17] = 'UNDM';
            headers[19] = 'Cantidad';

            // Crear array de datos para Excel
            const excelData = [headers];

            summaryData.forEach(item => {
                const row = new Array(20).fill('');
                row[8] = String(item.usuario || '').trim();
                row[10] = String(item.oc || '').trim();
                row[14] = String(item.codigo || '').trim();
                row[15] = String(item.descripcion || '').trim();
                row[17] = String(item.undm || '').trim();
                row[19] = String(item.cantidad || '').trim();
                excelData.push(row);
            });

            // Crear libro Excel con XLSX
            const worksheet = XLSX.utils.aoa_to_sheet(excelData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Datos');

            // Descargar archivo .xlsx
            const fecha = new Date().toISOString().slice(0,10);
            XLSX.writeFile(workbook, `datos_impresion_${fecha}.xlsx`);

            showMessage('Archivo Excel descargado: ' + summaryData.length + ' registros', 'success');
        }
</script>
</body>
</html>